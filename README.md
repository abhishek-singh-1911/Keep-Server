# Keep Server - Developer Documentation

> **A collaborative, real-time list-making application backend built with Node.js, Express, TypeScript, and MongoDB.**

---

## ğŸ“‹ Table of Contents

1. [Project Overview](#project-overview)
2. [Technology Stack](#technology-stack)
3. [Project Structure](#project-structure)
4. [Getting Started](#getting-started)
5. [Database Schema](#database-schema)
6. [API Endpoints](#api-endpoints)
7. [Authentication & Authorization](#authentication--authorization)
8. [Middleware](#middleware)
9. [Testing](#testing)
10. [Code Examples](#code-examples)
11. [Deployment](#deployment)
12. [Contributing](#contributing)

---

## ğŸ¯ Project Overview

**Keep** is a collaborative list-making application (similar to Google Keep) that allows users to:
- Create and manage lists
- Add collaborators to lists
- Add, update, and delete items within lists
- Real-time collaboration (planned for Step 6)

### Key Features
- âœ… User authentication with JWT
- âœ… List creation and management
- âœ… Collaboration system (add/remove collaborators)
- âœ… Item CRUD operations
- âœ… Owner-only and collaborative access controls
- âœ… Comprehensive test coverage (34 tests)

---

## ğŸ›  Technology Stack

### Core Technologies
- **Runtime**: Node.js
- **Language**: TypeScript
- **Framework**: Express.js
- **Database**: MongoDB (via Mongoose ODM)
- **Authentication**: JWT (JSON Web Tokens)
- **Password Hashing**: bcryptjs
- **Real-time** (planned): Socket.IO

### Development Tools
- **Testing**: Jest + Supertest
- **Environment Variables**: dotenv
- **Development Server**: nodemon + ts-node

---

## ğŸ“ Project Structure

```
keep/server/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â””â”€â”€ authMiddleware.ts       # JWT auth & list access middleware
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ user.ts                 # User schema & model
â”‚   â”‚   â””â”€â”€ list.ts                 # List schema & model
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ authRoutes.ts           # Authentication endpoints
â”‚   â”‚   â””â”€â”€ listRoutes.ts           # List & item endpoints
â”‚   â”œâ”€â”€ tests/
â”‚   â”‚   â”œâ”€â”€ auth.test.ts            # Auth & list creation tests
â”‚   â”‚   â”œâ”€â”€ list_crud.test.ts       # List CRUD & collaboration tests
â”‚   â”‚   â””â”€â”€ list_items.test.ts      # Item CRUD tests
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â””â”€â”€ idGenerator.ts          # ID generation utilities
â”‚   â””â”€â”€ server.ts                   # Main server file
â”œâ”€â”€ .env                            # Environment variables (gitignored)
â”œâ”€â”€ .env.example                    # Environment template
â”œâ”€â”€ package.json                    # Dependencies & scripts
â”œâ”€â”€ tsconfig.json                   # TypeScript configuration
â”œâ”€â”€ jest.config.js                  # Jest testing configuration
â””â”€â”€ README.md                       # This file
```

---

## ğŸš€ Getting Started

### Prerequisites
- Node.js (v16 or higher)
- MongoDB Atlas account (or local MongoDB)
- npm or yarn

### Installation

1. **Clone the repository**
   ```bash
   cd keep/server
   ```

2. **Install dependencies**
   ```bash
   npm install
   ```

3. **Set up environment variables**
   ```bash
   cp .env.example .env
   ```

   Edit `.env` and add your values:
   ```env
   PORT=5002
   MONGODB_URI="mongodb+srv://username:password@cluster.mongodb.net/?appName=KeepCluster"
   JWT_SECRET="your-secret-key-here"
   ```

4. **Run the development server**
   ```bash
   npm run dev
   ```

   Server will start at `http://localhost:5002`

5. **Run tests**
   ```bash
   npm test -- --runInBand
   ```

### Available Scripts

| Command | Description |
|---------|-------------|
| `npm start` | Run production server |
| `npm run dev` | Run development server with auto-reload |
| `npm test` | Run all tests |
| `npm test -- --runInBand` | Run tests sequentially (recommended) |
| `npm test -- --coverage` | Run tests with coverage report |

---

## ğŸ—„ Database Schema

### User Model (`/src/models/user.ts`)

```typescript
{
  _id: ObjectId,              // Auto-generated by MongoDB
  name: string,               // User's display name
  email: string,              // Unique email (used for login)
  password: string,           // Hashed password (bcrypt)
  createdAt: Date,            // Auto-generated timestamp
  updatedAt: Date             // Auto-updated timestamp
}
```

**Key Features:**
- Email is unique and indexed
- Password is hashed before saving (pre-save hook)
- Includes `comparePassword()` method for authentication

### List Model (`/src/models/list.ts`)

```typescript
{
  _id: ObjectId,              // Auto-generated by MongoDB
  listId: string,             // Short, readable ID (e.g., "gftr-1234")
  name: string,               // List name
  owner: ObjectId,            // Reference to User (required)
  collaborators: [ObjectId],  // Array of User references
  items: [                    // Array of list items
    {
      itemId: string,         // Unique item ID
      text: string,           // Item text
      completed: boolean      // Completion status
    }
  ],
  createdAt: Date,            // Auto-generated timestamp
  updatedAt: Date             // Auto-updated timestamp
}
```

**Key Features:**
- `listId` is unique and indexed
- `owner` is required and references User model
- `collaborators` array stores User ObjectIds
- `items` is an embedded array (no separate collection)

---

## ğŸ”Œ API Endpoints

### Base URL
```
http://localhost:5002/api
```

### Authentication Endpoints

#### 1. Register User
```http
POST /api/auth/register
Content-Type: application/json

{
  "name": "John Doe",
  "email": "john@example.com",
  "password": "password123"
}
```

**Response (201 Created):**
```json
{
  "_id": "507f1f77bcf86cd799439011",
  "name": "John Doe",
  "email": "john@example.com",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

#### 2. Login User
```http
POST /api/auth/login
Content-Type: application/json

{
  "email": "john@example.com",
  "password": "password123"
}
```

**Response (200 OK):**
```json
{
  "_id": "507f1f77bcf86cd799439011",
  "name": "John Doe",
  "email": "john@example.com",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

---

### List Endpoints

#### 3. Create List
```http
POST /api/lists
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "Shopping List"
}
```

**Response (201 Created):**
```json
{
  "listId": "gftr-1234",
  "name": "Shopping List"
}
```

**Access:** Authenticated users only

---

#### 4. Get List
```http
GET /api/lists/:listId
```

**Response (200 OK):**
```json
{
  "_id": "507f1f77bcf86cd799439011",
  "listId": "gftr-1234",
  "name": "Shopping List",
  "owner": "507f1f77bcf86cd799439012",
  "collaborators": ["507f1f77bcf86cd799439013"],
  "items": [
    {
      "itemId": "item-1234567890-xyz",
      "text": "Buy milk",
      "completed": false
    }
  ],
  "createdAt": "2025-11-25T12:00:00.000Z",
  "updatedAt": "2025-11-25T12:30:00.000Z"
}
```

**Access:** Public (no authentication required)

---

#### 5. Update List Name
```http
PUT /api/lists/:listId
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "Updated Shopping List"
}
```

**Response (200 OK):** Full list object

**Access:** Owner only

---

#### 6. Delete List
```http
DELETE /api/lists/:listId
Authorization: Bearer <token>
```

**Response (200 OK):**
```json
{
  "message": "List removed"
}
```

**Access:** Owner only

---

### Collaboration Endpoints

#### 7. Add Collaborator
```http
POST /api/lists/:listId/collaborators
Authorization: Bearer <token>
Content-Type: application/json

{
  "email": "collaborator@example.com"
}
```

**Response (200 OK):** Full list object with updated collaborators

**Access:** Owner only

**Validations:**
- User must exist
- User cannot already be a collaborator
- Owner cannot add themselves

---

#### 8. Remove Collaborator
```http
DELETE /api/lists/:listId/collaborators
Authorization: Bearer <token>
Content-Type: application/json

{
  "email": "collaborator@example.com"
}
```

**Response (200 OK):** Full list object with updated collaborators

**Access:** Owner only

---

### Item Endpoints

#### 9. Add Item
```http
POST /api/lists/:listId/items
Authorization: Bearer <token>
Content-Type: application/json

{
  "text": "Buy groceries"
}
```

**Response (201 Created):** Full list object with new item

**Access:** Owner + Collaborators

---

#### 10. Update Item
```http
PUT /api/lists/:listId/items/:itemId
Authorization: Bearer <token>
Content-Type: application/json

{
  "text": "Buy organic groceries",
  "completed": true
}
```

**Response (200 OK):** Full list object with updated item

**Access:** Owner + Collaborators

**Notes:**
- Both `text` and `completed` are optional
- Can update one or both fields

---

#### 11. Delete Item
```http
DELETE /api/lists/:listId/items/:itemId
Authorization: Bearer <token>
```

**Response (200 OK):** Full list object without deleted item

**Access:** Owner + Collaborators

---

### Error Responses

All endpoints return standard HTTP error codes:

```json
// 400 Bad Request
{
  "message": "User already exists."
}

// 401 Unauthorized
{
  "message": "Not authorized, no token"
}

// 403 Forbidden
{
  "message": "Not authorized to access this list"
}

// 404 Not Found
{
  "message": "List not found"
}

// 500 Internal Server Error
{
  "message": "Server error"
}
```

---

## ğŸ” Authentication & Authorization

### JWT Authentication Flow

1. **User Registration/Login**
   - User provides email and password
   - Server validates credentials
   - Server generates JWT token with user ID
   - Token is returned to client

2. **Protected Route Access**
   - Client includes token in `Authorization` header
   - Format: `Authorization: Bearer <token>`
   - Server validates token using `protect` middleware
   - User object is attached to `req.user`

### JWT Token Structure

```typescript
{
  id: string,        // User's MongoDB _id
  iat: number,       // Issued at timestamp
  exp: number        // Expiration timestamp (30 days)
}
```

### Authorization Levels

| Level | Endpoints | Description |
|-------|-----------|-------------|
| **Public** | GET `/api/lists/:listId` | No authentication required |
| **Authenticated** | POST `/api/lists` | Valid JWT required |
| **Owner Only** | PUT/DELETE list, Add/Remove collaborators | Must be list owner |
| **Owner + Collaborators** | Item CRUD operations | Must be owner or collaborator |

---

## ğŸ›¡ Middleware

### 1. `protect` Middleware

**Location:** `/src/middleware/authMiddleware.ts`

**Purpose:** Verify JWT token and authenticate user

**Usage:**
```typescript
router.post('/api/lists', protect, async (req: AuthRequest, res: Response) => {
  // req.user is now available
});
```

**Flow:**
1. Extract token from `Authorization` header
2. Verify token using JWT_SECRET
3. Find user by ID from token
4. Attach user to `req.user`
5. Call `next()` or return 401

---

### 2. `protectListAccess` Middleware

**Location:** `/src/middleware/authMiddleware.ts`

**Purpose:** Verify user has access to a list (owner OR collaborator)

**Usage:**
```typescript
router.post('/:listId/items', protect, protectListAccess, async (req, res) => {
  // User is guaranteed to be owner or collaborator
});
```

**Flow:**
1. Extract `listId` from route params
2. Find list in database
3. Check if user is owner or collaborator
4. Call `next()` or return 403

**Note:** Must be used AFTER `protect` middleware

---

## ğŸ§ª Testing

### Test Structure

We use **Jest** and **Supertest** for testing. All tests are in `/src/tests/`.

### Test Files

| File | Tests | Coverage |
|------|-------|----------|
| `auth.test.ts` | 8 | Authentication & list creation |
| `list_crud.test.ts` | 10 | List CRUD & collaboration |
| `list_items.test.ts` | 16 | Item CRUD operations |
| **Total** | **34** | **Complete backend coverage** |

### Running Tests

```bash
# Run all tests sequentially (recommended)
npm test -- --runInBand

# Run specific test file
npm test -- src/tests/list_items.test.ts

# Run with coverage
npm test -- --coverage

# Watch mode
npm test -- --watch
```

### Test Database

Tests use the same MongoDB database specified in `.env`. The test suite:
- Cleans up before each test file runs (`beforeAll`)
- Cleans up after each test file completes (`afterAll`)
- Uses `NODE_ENV=test` to prevent server auto-start

### Writing Tests

Example test structure:

```typescript
import request from 'supertest';
import mongoose from 'mongoose';
import app from '../server';
import User from '../models/user';

beforeAll(async () => {
  await mongoose.connect(process.env.MONGODB_URI!);
  await User.deleteMany({});
});

afterAll(async () => {
  await User.deleteMany({});
  await mongoose.connection.close();
});

describe('Feature Name', () => {
  it('should do something', async () => {
    const res = await request(app)
      .post('/api/endpoint')
      .send({ data: 'value' });
    
    expect(res.statusCode).toBe(200);
    expect(res.body.field).toBe('expected');
  });
});
```

---

## ğŸ’» Code Examples

### Creating a List with Items

```typescript
// 1. Register/Login
const authRes = await fetch('http://localhost:5002/api/auth/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    email: 'user@example.com',
    password: 'password123'
  })
});
const { token } = await authRes.json();

// 2. Create a list
const listRes = await fetch('http://localhost:5002/api/lists', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  },
  body: JSON.stringify({ name: 'My Shopping List' })
});
const { listId } = await listRes.json();

// 3. Add items
await fetch(`http://localhost:5002/api/lists/${listId}/items`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  },
  body: JSON.stringify({ text: 'Buy milk' })
});

// 4. Add collaborator
await fetch(`http://localhost:5002/api/lists/${listId}/collaborators`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  },
  body: JSON.stringify({ email: 'collaborator@example.com' })
});
```

### Using Middleware in Routes

```typescript
import { protect, protectListAccess, AuthRequest } from '../middleware/authMiddleware';

// Owner-only endpoint
router.delete('/:listId', protect, async (req: AuthRequest, res: Response) => {
  const list = await List.findOne({ listId: req.params.listId });
  
  if (list.owner.toString() !== req.user?._id.toString()) {
    return res.status(403).json({ message: 'Not authorized' });
  }
  
  await list.deleteOne();
  res.json({ message: 'List removed' });
});

// Owner + Collaborator endpoint
router.post('/:listId/items', protect, protectListAccess, async (req: AuthRequest, res: Response) => {
  // User is guaranteed to have access
  const list = await List.findOne({ listId: req.params.listId });
  list.items.push({ itemId: generateItemId(), text: req.body.text, completed: false });
  await list.save();
  res.status(201).json(list);
});
```

---

## ğŸš€ Deployment

### Environment Variables

Ensure these are set in production:

```env
PORT=5002
MONGODB_URI="mongodb+srv://..."
JWT_SECRET="strong-random-secret"
NODE_ENV="production"
```

### Deployment Platforms

**Recommended platforms:**
- **Heroku** - Easy deployment with MongoDB Atlas
- **Railway** - Modern platform with auto-deploy
- **DigitalOcean App Platform** - Simple scaling
- **AWS EC2/ECS** - Full control
- **Render** - Free tier available

### Docker Deployment (Future)

```dockerfile
# Dockerfile (to be created)
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install --production
COPY . .
RUN npm run build
EXPOSE 5002
CMD ["npm", "start"]
```

---

## ğŸ¤ Contributing

### Code Style

- Use TypeScript for all new code
- Follow existing naming conventions
- Add JSDoc comments for complex functions
- Keep functions small and focused

### Adding New Endpoints

1. Define route in appropriate file (`authRoutes.ts` or `listRoutes.ts`)
2. Add middleware (`protect`, `protectListAccess`) as needed
3. Implement business logic
4. Add error handling
5. Write tests in corresponding test file
6. Update this documentation

### Commit Guidelines

```
feat: Add user profile endpoint
fix: Resolve token expiration issue
test: Add tests for item deletion
docs: Update API documentation
refactor: Simplify list access middleware
```

---

## ğŸ“š Additional Resources

### MongoDB & Mongoose
- [Mongoose Documentation](https://mongoosejs.com/docs/)
- [MongoDB Atlas](https://www.mongodb.com/cloud/atlas)

### Express & TypeScript
- [Express.js Guide](https://expressjs.com/en/guide/routing.html)
- [TypeScript Handbook](https://www.typescriptlang.org/docs/)

### Testing
- [Jest Documentation](https://jestjs.io/docs/getting-started)
- [Supertest GitHub](https://github.com/visionmedia/supertest)

### Authentication
- [JWT.io](https://jwt.io/)
- [bcrypt Documentation](https://www.npmjs.com/package/bcryptjs)

---

## ğŸ“ Support

For questions or issues:
1. Check existing tests for examples
2. Review this documentation
3. Check MongoDB Atlas connection
4. Verify environment variables

---

## ğŸ“„ License

This project is part of the Keep collaborative application.

---

**Last Updated:** 2025-11-25  
**Version:** 1.0.0  
**Status:** Core functionality complete âœ…
